<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Económico: Comprar vs. Overhaul</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for better chart responsiveness */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans">

    <div class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-screen-xl mx-auto">
            <header class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Análisis Económico: Comprar vs. Overhaul</h1>
                <p class="text-slate-600 mt-2 text-lg">Herramienta interactiva para la toma de decisiones de inversión en activos de transporte.</p>
            </header>

            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
                <!-- --- Panel de Entradas --- -->
                <div id="inputs-panel" class="xl:col-span-1 flex flex-col gap-6">
                    <!-- Datos del Camión Nuevo -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-slate-700 border-b pb-2 mb-4">Datos del Camión Nuevo</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="newTruckCost" class="block text-sm font-medium text-slate-600">Costo de Adquisición ($)</label>
                                <input type="number" id="newTruckCost" value="4000000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="newTruckLifespan" class="block text-sm font-medium text-slate-600">Vida Útil Estimada (Años)</label>
                                <input type="number" id="newTruckLifespan" value="10" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="newTruckSalvage" class="block text-sm font-medium text-slate-600">Valor de Rescate ($)</label>
                                <input type="number" id="newTruckSalvage" value="800000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="newTruckMaintBase" class="block text-sm font-medium text-slate-600">Mantenimiento Base Anual ($)</label>
                                <input type="number" id="newTruckMaintBase" value="100000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="newTruckMaintIncrease" class="block text-sm font-medium text-slate-600">Incremento Anual Mantenimiento (%)</label>
                                <input type="number" id="newTruckMaintIncrease" value="0.15" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                    <!-- Datos del Overhaul -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-slate-700 border-b pb-2 mb-4">Datos del Overhaul</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="overhaulCost" class="block text-sm font-medium text-slate-600">Costo Total del Overhaul ($)</label>
                                <input type="number" id="overhaulCost" value="1200000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="overhaulLifeExtension" class="block text-sm font-medium text-slate-600">Extensión de Vida Útil (Años)</label>
                                <input type="number" id="overhaulLifeExtension" value="7" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="overhaulSalvage" class="block text-sm font-medium text-slate-600">Valor de Rescate Post-Overhaul ($)</label>
                                <input type="number" id="overhaulSalvage" value="300000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="overhaulMaintReduction" class="block text-sm font-medium text-slate-600">Reducción Mantenimiento Post-Overhaul (%)</label>
                                <input type="number" id="overhaulMaintReduction" value="0.5" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="currentTruckAge" class="block text-sm font-medium text-slate-600">Antigüedad Actual del Camión (Años)</label>
                                <input type="number" id="currentTruckAge" value="5" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                    <!-- Parámetros Financieros y Operativos -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                         <h2 class="text-xl font-bold text-slate-700 border-b pb-2 mb-4">Parámetros Financieros y Operativos</h2>
                         <div class="space-y-4">
                            <div>
                                <label for="discountRate" class="block text-sm font-medium text-slate-600">Tasa de Descuento / Costo de Oportunidad (%)</label>
                                <input type="number" id="discountRate" value="0.12" step="0.01" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="downtimeCostPerDay" class="block text-sm font-medium text-slate-600">Costo por Día de Inactividad ($)</label>
                                <input type="number" id="downtimeCostPerDay" value="15000" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="downtimeDaysBase" class="block text-sm font-medium text-slate-600">Días Inactividad Base (por año)</label>
                                <input type="number" id="downtimeDaysBase" value="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="downtimeDaysIncrease" class="block text-sm font-medium text-slate-600">Incr. Días Inactividad (por año)</label>
                                <input type="number" id="downtimeDaysIncrease" value="1.2" step="0.1" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                             <div>
                                <label for="analysisHorizon" class="block text-sm font-medium text-slate-600">Horizonte de Análisis (Años)</label>
                                <input type="number" id="analysisHorizon" value="20" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                         </div>
                    </div>
                </div>

                <!-- --- Panel de Resultados --- -->
                <div class="xl:col-span-3 flex flex-col gap-8">
                    <!-- Resumen Ejecutivo -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <h2 class="text-2xl font-bold text-slate-800">Resumen Ejecutivo</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-center">
                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-indigo-800">CAE Camión Nuevo</h3>
                                <p id="eacNewResult" class="text-2xl font-bold text-indigo-600">$0</p>
                            </div>
                            <div class="bg-teal-50 p-4 rounded-lg">
                                <h3 class="text-sm font-semibold text-teal-800">CAE Opción Overhaul</h3>
                                <p id="eacOverhaulResult" class="text-2xl font-bold text-teal-600">$0</p>
                            </div>
                        </div>
                        <p id="recommendationResult" class="mt-5 text-slate-700 bg-slate-50 p-4 rounded-md text-center font-medium"></p>
                    </div>

                    <!-- Gráficas -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-slate-700 mb-6">Visualización de Costos</h2>
                        <div class="chart-container mb-8">
                            <h3 class="text-center font-semibold text-slate-600 mb-2">Costo Acumulado (Valor Presente Neto)</h3>
                            <canvas id="cumulativeNpvChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 class="text-center font-semibold text-slate-600 mb-2">Costo Anual (Flujo de Caja)</h3>
                            <canvas id="annualCostChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Tabla Detallada -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold text-slate-700 mb-4">Tabla de Análisis Detallado</h2>
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Año</th>
                                        <th scope="col" class="px-6 py-3">Costo Anual (Nuevo)</th>
                                        <th scope="col" class="px-6 py-3">Costo Anual (Mantener)</th>
                                        <th scope="col" class="px-6 py-3">VPN Acum. (Nuevo)</th>
                                        <th scope="col" class="px-6 py-3">VPN Acum. (Mantener)</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Rows will be injected by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Chart instances ---
            let cumulativeChartInstance = null;
            let annualChartInstance = null;

            // --- Helper Functions ---
            const formatCurrency = (value) => {
                if (isNaN(value) || value === null) return '$0';
                return new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(value);
            };

            const calculateNPV = (cashflow, rate) => {
                let npv = 0;
                cashflow.forEach((cf, year) => {
                    npv += cf / Math.pow(1 + rate, year + 1);
                });
                return npv;
            };

            const calculateEAC = (npv, rate, n) => {
                if (rate === 0) return n > 0 ? npv / n : 0;
                if (n <= 0) return 0;
                const numerator = rate * Math.pow(1 + rate, n);
                const denominator = Math.pow(1 + rate, n) - 1;
                if (denominator === 0) return 0;
                return npv * (numerator / denominator);
            };

            // --- Main Analysis Function ---
            function runAnalysis() {
                // Read all input values
                const inputs = {
                    newTruckCost: parseFloat(document.getElementById('newTruckCost').value),
                    newTruckLifespan: parseInt(document.getElementById('newTruckLifespan').value),
                    newTruckSalvage: parseFloat(document.getElementById('newTruckSalvage').value),
                    newTruckMaintBase: parseFloat(document.getElementById('newTruckMaintBase').value),
                    newTruckMaintIncrease: parseFloat(document.getElementById('newTruckMaintIncrease').value),
                    overhaulCost: parseFloat(document.getElementById('overhaulCost').value),
                    overhaulLifeExtension: parseInt(document.getElementById('overhaulLifeExtension').value),
                    overhaulSalvage: parseFloat(document.getElementById('overhaulSalvage').value),
                    overhaulMaintReduction: parseFloat(document.getElementById('overhaulMaintReduction').value),
                    currentTruckAge: parseInt(document.getElementById('currentTruckAge').value),
                    discountRate: parseFloat(document.getElementById('discountRate').value),
                    downtimeCostPerDay: parseFloat(document.getElementById('downtimeCostPerDay').value),
                    downtimeDaysBase: parseInt(document.getElementById('downtimeDaysBase').value),
                    downtimeDaysIncrease: parseFloat(document.getElementById('downtimeDaysIncrease').value),
                    analysisHorizon: parseInt(document.getElementById('analysisHorizon').value),
                };

                // --- Core Calculation Logic (ported from React) ---
                const {
                    newTruckCost, newTruckLifespan, newTruckSalvage, newTruckMaintBase, newTruckMaintIncrease,
                    overhaulCost, overhaulLifeExtension, overhaulSalvage, overhaulMaintReduction, currentTruckAge,
                    discountRate, downtimeCostPerDay, downtimeDaysBase, downtimeDaysIncrease, analysisHorizon
                } = inputs;

                // Escenario 1: Análisis de Camión Nuevo
                const newTruckAnnualCosts = [];
                for (let i = 1; i <= newTruckLifespan; i++) {
                    const maintCost = newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, i - 1);
                    const downtimeCost = (downtimeDaysBase * (i / 2)) * downtimeCostPerDay;
                    newTruckAnnualCosts.push(maintCost + downtimeCost);
                }
                const newTruckCashFlows = [-newTruckCost, ...newTruckAnnualCosts.map(c => -c)];
                newTruckCashFlows[newTruckLifespan] += newTruckSalvage;
                const newTruckNPV = newTruckCashFlows.reduce((acc, val, i) => acc + val / Math.pow(1 + discountRate, i), 0);
                const newTruckEAC = -calculateEAC(newTruckNPV, discountRate, newTruckLifespan);

                // Escenario 2: Análisis de Mantener y Hacer Overhaul
                let optimalOverhaulYear = -1;
                let minEacOverhaul = Infinity;
                for (let yearOfOverhaul = currentTruckAge; yearOfOverhaul <= analysisHorizon - overhaulLifeExtension; yearOfOverhaul++) {
                    let currentCosts = [];
                    for (let i = currentTruckAge; i < yearOfOverhaul; i++) {
                        const maintCost = newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, i);
                        const downtimeCost = (downtimeDaysBase + (downtimeDaysIncrease * i)) * downtimeCostPerDay;
                        currentCosts.push(-(maintCost + downtimeCost));
                    }
                    currentCosts.push(-overhaulCost);
                    const baseMaintPostOverhaul = newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, yearOfOverhaul) * (1 - overhaulMaintReduction);
                    for (let i = 1; i <= overhaulLifeExtension; i++) {
                        const maintCost = baseMaintPostOverhaul * Math.pow(1 + newTruckMaintIncrease, i - 1);
                        const downtimeCost = (downtimeDaysBase + (downtimeDaysIncrease * i)) * downtimeCostPerDay * (1 - overhaulMaintReduction);
                        currentCosts.push(-(maintCost + downtimeCost));
                    }
                    currentCosts[currentCosts.length - 1] += overhaulSalvage;
                    const npvThisOption = currentCosts.reduce((acc, val, i) => acc + val / Math.pow(1 + discountRate, i), 0);
                    const totalLife = (yearOfOverhaul - currentTruckAge) + overhaulLifeExtension;
                    const eacThisOption = -calculateEAC(npvThisOption, discountRate, totalLife);
                    if (eacThisOption < minEacOverhaul) {
                        minEacOverhaul = eacThisOption;
                        optimalOverhaulYear = yearOfOverhaul;
                    }
                }

                // Generar Datos para la Tabla Año por Año
                const analysisData = [];
                let cumulativeNpvNew = 0;
                let cumulativeNpvKeep = 0;
                let hasBeenOverhauled = false;
                for (let year = 1; year <= analysisHorizon; year++) {
                    const absoluteYear = currentTruckAge + year - 1;
                    let costNewThisYear = 0;
                    if (year === 1) costNewThisYear += newTruckCost;
                    if (year <= newTruckLifespan) {
                        costNewThisYear += newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, year - 1);
                        costNewThisYear += (downtimeDaysBase * (year / 2)) * downtimeCostPerDay;
                    }
                    if (year === newTruckLifespan) costNewThisYear -= newTruckSalvage;
                    const npvNewThisYear = costNewThisYear / Math.pow(1 + discountRate, year);
                    cumulativeNpvNew += npvNewThisYear;

                    let costKeepThisYear = 0;
                    if (absoluteYear === optimalOverhaulYear && !hasBeenOverhauled) {
                        costKeepThisYear += overhaulCost;
                        hasBeenOverhauled = true;
                    }
                    if (!hasBeenOverhauled) {
                        costKeepThisYear += newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, absoluteYear);
                        costKeepThisYear += (downtimeDaysBase + (downtimeDaysIncrease * absoluteYear)) * downtimeCostPerDay;
                    } else {
                        const yearsSinceOverhaul = absoluteYear - optimalOverhaulYear + 1;
                        if (yearsSinceOverhaul > 0 && yearsSinceOverhaul <= overhaulLifeExtension) {
                            const baseMaintPostOverhaul = newTruckMaintBase * Math.pow(1 + newTruckMaintIncrease, optimalOverhaulYear) * (1 - overhaulMaintReduction);
                            costKeepThisYear += baseMaintPostOverhaul * Math.pow(1 + newTruckMaintIncrease, yearsSinceOverhaul - 1);
                            costKeepThisYear += (downtimeDaysBase + (downtimeDaysIncrease * yearsSinceOverhaul)) * downtimeCostPerDay * (1 - overhaulMaintReduction);
                        }
                    }
                    if (hasBeenOverhauled && (absoluteYear - optimalOverhaulYear + 1) === overhaulLifeExtension) {
                        costKeepThisYear -= overhaulSalvage;
                    }
                    const npvKeepThisYear = costKeepThisYear / Math.pow(1 + discountRate, year);
                    cumulativeNpvKeep += npvKeepThisYear;

                    analysisData.push({
                        yearLabel: `Año ${year} (Abs. ${absoluteYear})`,
                        costNew: year > newTruckLifespan ? 0 : costNewThisYear,
                        costKeep: costKeepThisYear,
                        cumulativeNpvNew,
                        cumulativeNpvKeep,
                    });
                }

                // Generar Recomendación
                let recommendationText = `Basado en el Costo Anual Equivalente (CAE), la opción más económica es `;
                if (newTruckEAC < minEacOverhaul) {
                    recommendationText += `comprar un camión nuevo.`;
                } else {
                    recommendationText += `realizar un overhaul. El año óptimo para el overhaul es al final del año ${optimalOverhaulYear} de antigüedad del camión.`;
                }
                const crossoverData = analysisData.find(d => d.cumulativeNpvKeep > d.cumulativeNpvNew);
                if (crossoverData) {
                    recommendationText += ` El costo acumulado de mantener el camión supera al de comprar uno nuevo en el ${crossoverData.yearLabel}.`
                }

                // --- Render Results to DOM ---
                document.getElementById('eacNewResult').textContent = formatCurrency(newTruckEAC);
                document.getElementById('eacOverhaulResult').textContent = formatCurrency(minEacOverhaul);
                document.getElementById('recommendationResult').textContent = recommendationText;

                const tableBody = document.getElementById('resultsTableBody');
                tableBody.innerHTML = analysisData.map(row => `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${row.yearLabel}</th>
                        <td class="px-6 py-4">${formatCurrency(row.costNew)}</td>
                        <td class="px-6 py-4">${formatCurrency(row.costKeep)}</td>
                        <td class="px-6 py-4 font-semibold text-indigo-700">${formatCurrency(row.cumulativeNpvNew)}</td>
                        <td class="px-6 py-4 font-semibold text-teal-700">${formatCurrency(row.cumulativeNpvKeep)}</td>
                    </tr>
                `).join('');

                // --- Update Charts ---
                const labels = analysisData.map(d => d.yearLabel);

                // Cumulative NPV Chart
                if (cumulativeChartInstance) {
                    cumulativeChartInstance.destroy();
                }
                const cumulativeCtx = document.getElementById('cumulativeNpvChart').getContext('2d');
                cumulativeChartInstance = new Chart(cumulativeCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Comprar Nuevo',
                            data: analysisData.map(d => d.cumulativeNpvNew),
                            borderColor: '#4f46e5',
                            backgroundColor: '#4f46e5',
                            fill: false,
                            tension: 0.1
                        }, {
                            label: 'Mantener/Overhaul',
                            data: analysisData.map(d => d.cumulativeNpvKeep),
                            borderColor: '#14b8a6',
                            backgroundColor: '#14b8a6',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { ticks: { callback: (value) => formatCurrency(value) } }
                        },
                        plugins: { tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                    }
                });

                // Annual Cost Chart
                if (annualChartInstance) {
                    annualChartInstance.destroy();
                }
                const annualCtx = document.getElementById('annualCostChart').getContext('2d');
                annualChartInstance = new Chart(annualCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Comprar Nuevo',
                            data: analysisData.map(d => d.costNew),
                            backgroundColor: '#818cf8',
                        }, {
                            label: 'Mantener/Overhaul',
                            data: analysisData.map(d => d.costKeep),
                            backgroundColor: '#5eead4',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { ticks: { callback: (value) => formatCurrency(value) } },
                            x: { stacked: true },
                        },
                        plugins: { tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}` } } }
                    }
                });
            }

            // --- Event Listeners ---
            const inputElements = document.querySelectorAll('#inputs-panel input');
            inputElements.forEach(input => input.addEventListener('input', runAnalysis));

            // --- Initial Run ---
            runAnalysis();
        });
    </script>

</body>
</html>