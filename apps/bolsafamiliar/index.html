<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Bolsa Familiar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .auth-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            margin: 0 auto;
        }

        .main-app {
            display: none;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover {
            background: #5a6fd8;
            color: white;
        }

        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .balance-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .request-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-info {
            flex: 1;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        .status-approved {
            color: #28a745;
            font-weight: bold;
        }

        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }

        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .request-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .request-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Bolsa Familiar</h1>
            <p>Control de gastos para toda la familia</p>
        </div>

        <!-- Autenticaci√≥n -->
        <div id="auth-container" class="auth-container">
            <h2 style="text-align: center; margin-bottom: 20px;">Bolsa Familiar</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Inicia sesi√≥n con tu cuenta familiar</p>
            
            <div id="error-container"></div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" placeholder="tu@email.com" onkeypress="handleEnterKey(event)">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="password" placeholder="Tu contrase√±a" onkeypress="handleEnterKey(event)">
            </div>
            <button class="btn btn-primary" id="login-btn" style="width: 100%;" onclick="login()">Iniciar Sesi√≥n</button>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                <strong>¬øNo tienes cuenta?</strong><br>
                Los usuarios deben ser creados por un administrador de la familia desde la configuraci√≥n de Firebase.
            </div>
        </div>

        <!-- Aplicaci√≥n Principal -->
        <div id="main-app" class="main-app">
            <div class="user-info">
                <span id="user-greeting"></span>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('home')">üè† Inicio</button>
                <button class="nav-tab" onclick="showTab('requests')">üìù Solicitudes</button>
                <button class="nav-tab" onclick="showTab('expenses')">üí≥ Gastos</button>
                <button class="nav-tab admin-only" onclick="showTab('admin')">üëë Admin</button>
            </div>

            <div class="tab-content">
                <!-- Pesta√±a Inicio -->
                <div id="home-tab" class="tab-pane active">
                    <div class="card">
                        <h3>üí∞ Balance de la Bolsa Familiar</h3>
                        <div class="balance-display" id="family-balance">$0.00</div>
                        <div style="text-align: center; color: #666; font-size: 14px;">
                            Presupuesto semanal: $<span id="weekly-budget-display">0</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="my-received">$0</div>
                            <div>Total Recibido</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="my-spent">$0</div>
                            <div>Total Gastado</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="my-requests">0</div>
                            <div>Mis Solicitudes</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üí∏ Hacer Solicitud de Dinero</h3>
                        <div id="request-form-messages"></div>
                        <div class="form-group">
                            <label>Cantidad ($):</label>
                            <input type="number" id="request-amount" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Motivo:</label>
                            <input type="text" id="request-reason" placeholder="¬øPara qu√© necesitas el dinero?" maxlength="100">
                        </div>
                        <button class="btn btn-primary" onclick="makeRequest()">Enviar Solicitud</button>
                    </div>
                </div>

                <!-- Pesta√±a Solicitudes -->
                <div id="requests-tab" class="tab-pane">
                    <div class="card">
                        <h3>üìã Mis Solicitudes</h3>
                        <div id="my-requests-list">
                            <div class="loading">Cargando solicitudes...</div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Gastos -->
                <div id="expenses-tab" class="tab-pane">
                    <div class="card">
                        <h3>‚ûï Registrar Gasto</h3>
                        <div id="expense-form-messages"></div>
                        <div class="form-group">
                            <label>Cantidad ($):</label>
                            <input type="number" id="expense-amount" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a:</label>
                            <select id="expense-category">
                                <option value="despensa">ü•ë Despensa</option>
                                <option value="comida">üçî Comida</option>
                                <option value="transporte">üöó Transporte</option>
                                <option value="entretenimiento">üéÆ Entretenimiento</option>
                                <option value="ropa">üëï Ropa</option>
                                <option value="salud">üè• Salud</option>
                                <option value="educacion">üìö Educaci√≥n</option>
                                <option value="servicios">‚òéÔ∏è Servicios</option>
                                <option value="otros">üì¶ Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <input type="text" id="expense-description" placeholder="Descripci√≥n del gasto" maxlength="100">
                        </div>
                        <button class="btn btn-success" onclick="addExpense()">Registrar Gasto</button>
                    </div>

                    <div class="card">
                        <h3>üìä Mis Gastos</h3>
                        <div id="my-expenses-list">
                            <div class="loading">Cargando gastos...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üìà Resumen por Categor√≠a</h3>
                        <div id="expenses-by-category"></div>
                    </div>
                </div>

                <!-- Pesta√±a Admin -->
                <div id="admin-tab" class="tab-pane admin-only">
                    <div class="card">
                        <h3>üí∞ Administrar Presupuesto Semanal</h3>
                        <div id="budget-form-messages"></div>
                        <div class="form-group">
                            <label>Presupuesto de la Semana ($):</label>
                            <input type="number" id="weekly-budget" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <button class="btn btn-primary" onclick="setWeeklyBudget()">Establecer Presupuesto</button>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px; font-size: 14px;">
                            <strong>üìÖ √öltima actualizaci√≥n:</strong> <span id="last-budget-update">-</span>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üìã Solicitudes Pendientes</h3>
                        <div id="pending-requests-list">
                            <div class="loading">Cargando solicitudes pendientes...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üìä Dashboard Familiar</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="total-spent">$0</div>
                                <div>Total Gastado</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="total-requests">0</div>
                                <div>Total Solicitudes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="pending-amount">$0</div>
                                <div>Pendiente por Aprobar</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="family-members">0</div>
                                <div>Miembros Activos</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 20px; color: #667eea;">üìà Gastos por Categor√≠a (Familia)</h4>
                        <div id="family-expenses-summary"></div>
                        
                        <h4 style="margin-top: 20px; color: #667eea;">üë• Actividad por Usuario</h4>
                        <div id="user-activity-summary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN DE FIREBASE
        // ========================================

          const firebaseConfig = {
            apiKey: "AIzaSyB8w5jajw-KUOJS3Eh7M4j0XVNlZc3rWHI",
            authDomain: "mibolsafamiliar.firebaseapp.com",
            projectId: "mibolsafamiliar",
            storageBucket: "mibolsafamiliar.firebasestorage.app",
            messagingSenderId: "507735475217",
            appId: "1:507735475217:web:1683e8f86194f63e805db0"
          };

        // Inicializar Firebase (descomenta cuando tengas la configuraci√≥n)
         firebase.initializeApp(firebaseConfig);
         const auth = firebase.auth();
         const database = firebase.database();

        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let currentUser = null;
        let userRole = null;
        let userName = null;
        let familyData = {};

        // Datos de ejemplo para demo (se reemplazar√° con Firebase)
        let demoData = {
            familySettings: {
                currentBalance: 1500,
                weeklyBudget: 2000,
                lastBudgetUpdate: "2025-06-08T10:00:00Z"
            },
            users: {
                'demo-admin': { 
                    name: 'Pap√° Admin', 
                    email: 'papa@familia.com',
                    role: 'admin' 
                },
                'demo-member': { 
                    name: 'Hijo 1', 
                    email: 'hijo1@familia.com',
                    role: 'member' 
                }
            },
            requests: [
                {
                    id: '1',
                    userId: 'demo-member',
                    userName: 'Hijo 1',
                    amount: 200,
                    reason: '√ötiles escolares',
                    status: 'pending',
                    createdAt: new Date().toISOString()
                }
            ],
            expenses: [
                {
                    id: '1',
                    userId: 'demo-member',
                    userName: 'Hijo 1',
                    amount: 50,
                    category: 'comida',
                    description: 'Almuerzo escuela',
                    createdAt: new Date().toISOString()
                }
            ]
        };

        // ========================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ========================================
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            clearMessages('error-container');

            if (!email || !password) {
                showError('error-container', 'Por favor completa todos los campos');
                return;
            }

            setLoading('login-btn', true);



            //C√≥digo para Firebase Auth:
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    Profile();
                })
                .catch((error) => {
                    setLoading('login-btn', false);
                    showError('error-container', getFirebaseErrorMessage(error.code));
                });
            
        }

        function loadUserProfile() {
            console.log("=== DEBUG LOAD USER PROFILE ===");
            console.log("currentUser:", currentUser);
            console.log("currentUser.uid:", currentUser.uid);
            console.log("currentUser.email:", currentUser.email);
            console.log("currentUser.displayName:", currentUser.displayName);
            
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    console.log("=== DEBUG USER DATA FROM DB ===");
                    console.log("userData completo:", userData);
                    console.log("userData.name:", userData?.name);
                    console.log("userData.role:", userData?.role);
                    console.log("userData.email:", userData?.email);
                    
                    if (!userData) {
                        showError('error-container', 'Usuario no encontrado en la familia. Contacta a un administrador.');
                        logout();
                        return;
                    }
                    
                    userRole = userData.role;
                    userName = userData.name;
                    console.log("=== DESPU√âS DE ASIGNACI√ìN ===");
                    console.log("userRole:", userRole);
                    console.log("currentUser.displayName:", currentUser.displayName);
                    
                    loadFamilyData();
                })
                .catch((error) => {
                    console.error("Error cargando perfil:", error);
                    showError('error-container', 'Error al cargar perfil: ' + error.message);
                });
        }

        function loadFamilyData() {
            // Para Firebase:
            Promise.all([
                database.ref('familySettings').once('value'),
                database.ref('users').once('value'),
                database.ref('requests').once('value'),
                database.ref('expenses').once('value')
            ]).then(([settingsSnapshot, usersSnapshot, requestsSnapshot, expensesSnapshot]) => {
                familyData = {
                    familySettings: settingsSnapshot.val() || {},
                    users: usersSnapshot.val() || {},
                    requests: requestsSnapshot.val() ? Object.values(requestsSnapshot.val()) : [],
                    expenses: expensesSnapshot.val() ? Object.values(expensesSnapshot.val()) : []
                };
                showMainApp();
            }).catch((error) => {
                showError('error-container', 'Error al cargar datos familiares: ' + error.message);
            });
            
        }

        function logout() {
            auth.signOut(); // Para Firebase
            currentUser = null;
            userRole = null;
            familyData = {};
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
            
            // Limpiar formularios
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            clearMessages('error-container');
        }

        // ========================================
        // FUNCIONES DE LA APLICACI√ìN PRINCIPAL
        // ========================================

        function showMainApp() {

            console.log("=== DEBUG SHOW MAIN APP ===");
            console.log("userName:", userName);
            console.log("userRole:", userRole);
            
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            document.getElementById('user-greeting').textContent = 
                `Hola, ${userName}! (${userRole === 'admin' ? 'Administrador' : 'Miembro'})`;
            
            // Mostrar/ocultar elementos de admin
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = userRole === 'admin' ? 'block' : 'none';
            });

            loadData();
        }

        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            // Mostrar la pesta√±a seleccionada
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos de la pesta√±a
            if (tabName === 'home') loadHomeData();
            if (tabName === 'requests') loadMyRequests();
            if (tabName === 'expenses') loadMyExpenses();
            if (tabName === 'admin' && userRole === 'admin') loadAdminData();
        }

        function loadData() {
            loadHomeData();
        }

        function loadHomeData() {
            // Cargar balance familiar
            const balance = familyData.familySettings.currentBalance || 0;
            const weeklyBudget = familyData.familySettings.weeklyBudget || 0;
            
            document.getElementById('family-balance').textContent = formatCurrency(balance);
            document.getElementById('weekly-budget-display').textContent = weeklyBudget.toLocaleString();
            
            loadMyStats();
        }

        function loadMyStats() {
            // Calcular estad√≠sticas del usuario actual
            const myRequests = (familyData.requests || []).filter(r => r.userId === currentUser.uid);
            const myExpenses = (familyData.expenses || []).filter(e => e.userId === currentUser.uid);
            
            const myReceived = myRequests
                .filter(r => r.status === 'approved')
                .reduce((sum, r) => sum + r.amount, 0);
            
            const mySpent = myExpenses.reduce((sum, e) => sum + e.amount, 0);
            const myRequestsCount = myRequests.length;

            document.getElementById('my-received').textContent = formatCurrency(myReceived);
            document.getElementById('my-spent').textContent = formatCurrency(mySpent);
            document.getElementById('my-requests').textContent = myRequestsCount;
        }

        // ========================================
        // FUNCIONES DE SOLICITUDES
        // ========================================

        function makeRequest() {
            const amount = parseFloat(document.getElementById('request-amount').value);
            const reason = document.getElementById('request-reason').value.trim();

            clearMessages('request-form-messages');

            if (!amount || amount <= 0) {
                showError('request-form-messages', 'Por favor ingresa una cantidad v√°lida');
                return;
            }

            if (!reason) {
                showError('request-form-messages', 'Por favor describe el motivo de la solicitud');
                return;
            }

            if (amount > familyData.familySettings.currentBalance) {
                showError('request-form-messages', 'La cantidad solicitada excede el balance familiar disponible');
                return;
            }

            const request = {
                id: Date.now().toString(),
                userId: currentUser.uid,
                userName: userName,
                amount: amount,
                reason: reason,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            // Para Firebase:
            database.ref('requests').push(request)
                .then(() => {
                    showSuccess('request-form-messages', 'Solicitud enviada exitosamente');
                    document.getElementById('request-amount').value = '';
                    document.getElementById('request-reason').value = '';
                    loadMyStats();
                })
                .catch((error) => {
                    showError('request-form-messages', 'Error al enviar solicitud: ' + error.message);
                });
            
        }

        function loadMyRequests() {
            const container = document.getElementById('my-requests-list');
            const myRequests = (familyData.requests || []).filter(r => r.userId === currentUser.uid);

            if (myRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No tienes solicitudes a√∫n.</p>';
                return;
            }

            // Ordenar por fecha m√°s reciente
            myRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            container.innerHTML = myRequests.map(request => `
                <div class="request-item">
                    <div class="request-info">
                        <strong>${formatCurrency(request.amount)}</strong> - ${request.reason}
                        <br><small>Estado: <span class="status-${request.status}">${getStatusText(request.status)}</span></small>
                        <br><small>${formatDate(request.createdAt)}</small>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // FUNCIONES DE GASTOS
        // ========================================

        function addExpense() {
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const description = document.getElementById('expense-description').value.trim();

            clearMessages('expense-form-messages');

            if (!amount || amount <= 0) {
                showError('expense-form-messages', 'Por favor ingresa una cantidad v√°lida');
                return;
            }

            if (!description) {
                showError('expense-form-messages', 'Por favor describe el gasto');
                return;
            }

            const expense = {
                id: Date.now().toString(),
                userId: currentUser.uid,
                userName: currentUser.displayName,
                amount: amount,
                category: category,
                description: description,
                createdAt: new Date().toISOString()
            };

            familyData.expenses.push(expense);

            // Limpiar formulario
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-description').value = '';

            showSuccess('expense-form-messages', 'Gasto registrado exitosamente');
            loadMyExpenses();
            loadMyStats();

            /* Para Firebase:
            database.ref('expenses').push(expense)
                .then(() => {
                    showSuccess('expense-form-messages', 'Gasto registrado exitosamente');
                    document.getElementById('expense-amount').value = '';
                    document.getElementById('expense-description').value = '';
                    loadMyExpenses();
                    loadMyStats();
                })
                .catch((error) => {
                    showError('expense-form-messages', 'Error al registrar gasto: ' + error.message);
                });
            */
        }

        function loadMyExpenses() {
            const container = document.getElementById('my-expenses-list');
            const myExpenses = familyData.expenses.filter(e => e.userId === currentUser.uid);

            if (myExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No has registrado gastos a√∫n.</p>';
            } else {
                // Ordenar por fecha m√°s reciente
                myExpenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                container.innerHTML = myExpenses.map(expense => `
                    <div class="expense-item">
                        <div>
                            <strong>${expense.description}</strong><br>
                            <small>${getCategoryIcon(expense.category)} ${getCategoryName(expense.category)}</small><br>
                            <small>${formatDate(expense.createdAt)}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${formatCurrency(expense.amount)}</strong>
                        </div>
                    </div>
                `).join('');
            }

            loadExpensesByCategory();
        }

        function loadExpensesByCategory() {
            const container = document.getElementById('expenses-by-category');
            const myExpenses = familyData.expenses.filter(e => e.userId === currentUser.uid);

            if (myExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay gastos para mostrar.</p>';
                return;
            }

            // Agrupar gastos por categor√≠a
            const expensesByCategory = {};
            myExpenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = 0;
                }
                expensesByCategory[expense.category] += expense.amount;
            });

            const total = Object.values(expensesByCategory).reduce((sum, amount) => sum + amount, 0);

            container.innerHTML = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .map(([category, amount]) => {
                    const percentage = ((amount / total) * 100).toFixed(1);
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #e0e0e0;">
                            <span>${getCategoryIcon(category)} ${getCategoryName(category)}</span>
                            <span><strong>${formatCurrency(amount)}</strong> (${percentage}%)</span>
                        </div>
                    `;
                }).join('');
        }

        // ========================================
        // FUNCIONES DE ADMINISTRACI√ìN
        // ========================================

        function setWeeklyBudget() {
            const budget = parseFloat(document.getElementById('weekly-budget').value);
            
            clearMessages('budget-form-messages');

            if (!budget || budget <= 0) {
                showError('budget-form-messages', 'Por favor ingresa un presupuesto v√°lido');
                return;
            }

            familyData.familySettings.weeklyBudget = budget;
            familyData.familySettings.currentBalance = budget;
            familyData.familySettings.lastBudgetUpdate = new Date().toISOString();
            
            document.getElementById('family-balance').textContent = formatCurrency(budget);
            document.getElementById('weekly-budget-display').textContent = budget.toLocaleString();
            document.getElementById('last-budget-update').textContent = formatDate(familyData.familySettings.lastBudgetUpdate);
            
            showSuccess('budget-form-messages', 'Presupuesto semanal establecido exitosamente');
            loadFamilyStats();

            /* Para Firebase:
            const updates = {
                'familySettings/weeklyBudget': budget,
                'familySettings/currentBalance': budget,
                'familySettings/lastBudgetUpdate': firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref().update(updates)
                .then(() => {
                    showSuccess('budget-form-messages', 'Presupuesto semanal establecido exitosamente');
                    loadHomeData();
                    loadFamilyStats();
                })
                .catch((error) => {
                    showError('budget-form-messages', 'Error al establecer presupuesto: ' + error.message);
                });
            */
        }

        function loadAdminData() {
            loadPendingRequests();
            loadFamilyStats();
            loadLastBudgetUpdate();
        }

        function loadPendingRequests() {
            const container = document.getElementById('pending-requests-list');
            const pendingRequests = familyData.requests.filter(r => r.status === 'pending');

            if (pendingRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay solicitudes pendientes.</p>';
                return;
            }

            container.innerHTML = pendingRequests.map(request => `
                <div class="request-item">
                    <div class="request-info">
                        <strong>${request.userName}</strong> solicita <strong>${formatCurrency(request.amount)}</strong>
                        <br>${request.reason}
                        <br><small>${formatDate(request.createdAt)}</small>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-success" onclick="approveRequest('${request.id}')">‚úì Aprobar</button>
                        <button class="btn btn-danger" onclick="rejectRequest('${request.id}')">‚úó Rechazar</button>
                    </div>
                </div>
            `).join('');
        }

        function approveRequest(requestId) {
            const request = familyData.requests.find(r => r.id === requestId);
            if (!request) return;

            if (request.amount > familyData.familySettings.currentBalance) {
                alert('No hay suficiente balance en la bolsa familiar para aprobar esta solicitud.');
                return;
            }

            request.status = 'approved';
            request.approvedAt = new Date().toISOString();
            request.approvedBy = currentUser.uid;
            
            familyData.familySettings.currentBalance -= request.amount;
            
            document.getElementById('family-balance').textContent = 
                formatCurrency(familyData.familySettings.currentBalance);
                
            loadPendingRequests();
            loadFamilyStats();
            loadHomeData();

            /* Para Firebase:
            const updates = {
                [`requests/${requestId}/status`]: 'approved',
                [`requests/${requestId}/approvedAt`]: firebase.database.ServerValue.TIMESTAMP,
                [`requests/${requestId}/approvedBy`]: currentUser.uid,
                'familySettings/currentBalance': familyData.familySettings.currentBalance
            };
            
            database.ref().update(updates)
                .then(() => {
                    loadPendingRequests();
                    loadFamilyStats();
                    loadHomeData();
                });
            */
        }

        function rejectRequest(requestId) {
            if (!confirm('¬øEst√°s seguro de rechazar esta solicitud?')) return;

            const request = familyData.requests.find(r => r.id === requestId);
            if (!request) return;

            request.status = 'rejected';
            request.rejectedAt = new Date().toISOString();
            request.rejectedBy = currentUser.uid;
            
            loadPendingRequests();
            loadFamilyStats();

            /* Para Firebase:
            const updates = {
                [`requests/${requestId}/status`]: 'rejected',
                [`requests/${requestId}/rejectedAt`]: firebase.database.ServerValue.TIMESTAMP,
                [`requests/${requestId}/rejectedBy`]: currentUser.uid
            };
            
            database.ref().update(updates)
                .then(() => {
                    loadPendingRequests();
                    loadFamilyStats();
                });
            */
        }

        function loadFamilyStats() {
            const totalSpent = familyData.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalRequests = familyData.requests.length;
            const pendingAmount = familyData.requests
                .filter(r => r.status === 'pending')
                .reduce((sum, r) => sum + r.amount, 0);
            const familyMembers = Object.keys(familyData.users).length;

            document.getElementById('total-spent').textContent = formatCurrency(totalSpent);
            document.getElementById('total-requests').textContent = totalRequests;
            document.getElementById('pending-amount').textContent = formatCurrency(pendingAmount);
            document.getElementById('family-members').textContent = familyMembers;

            loadFamilyExpensesSummary();
            loadUserActivitySummary();
        }

        function loadFamilyExpensesSummary() {
            const container = document.getElementById('family-expenses-summary');
            
            if (familyData.expenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No hay gastos familiares registrados.</p>';
                return;
            }

            // Agrupar gastos por categor√≠a
            const expensesByCategory = {};
            familyData.expenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = 0;
                }
                expensesByCategory[expense.category] += expense.amount;
            });

            const total = Object.values(expensesByCategory).reduce((sum, amount) => sum + amount, 0);

            container.innerHTML = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .map(([category, amount]) => {
                    const percentage = ((amount / total) * 100).toFixed(1);
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #e0e0e0;">
                            <span>${getCategoryIcon(category)} ${getCategoryName(category)}</span>
                            <span><strong>${formatCurrency(amount)}</strong> (${percentage}%)</span>
                        </div>
                    `;
                }).join('');
        }

        function loadUserActivitySummary() {
            const container = document.getElementById('user-activity-summary');
            const userStats = {};

            // Inicializar estad√≠sticas de usuarios
            Object.entries(familyData.users).forEach(([userId, user]) => {
                userStats[userId] = {
                    name: user.name,
                    role: user.role,
                    totalRequested: 0,
                    totalApproved: 0,
                    totalSpent: 0,
                    requestCount: 0
                };
            });

            // Calcular estad√≠sticas de solicitudes
            familyData.requests.forEach(request => {
                if (userStats[request.userId]) {
                    userStats[request.userId].totalRequested += request.amount;
                    userStats[request.userId].requestCount++;
                    if (request.status === 'approved') {
                        userStats[request.userId].totalApproved += request.amount;
                    }
                }
            });

            // Calcular estad√≠sticas de gastos
            familyData.expenses.forEach(expense => {
                if (userStats[expense.userId]) {
                    userStats[expense.userId].totalSpent += expense.amount;
                }
            });

            container.innerHTML = Object.values(userStats).map(user => `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${user.name}</strong>
                        <span style="background: ${user.role === 'admin' ? '#667eea' : '#28a745'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                            ${user.role === 'admin' ? 'Admin' : 'Miembro'}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 14px;">
                        <div>Solicitado: <strong>${formatCurrency(user.totalRequested)}</strong></div>
                        <div>Aprobado: <strong>${formatCurrency(user.totalApproved)}</strong></div>
                        <div>Gastado: <strong>${formatCurrency(user.totalSpent)}</strong></div>
                        <div>Solicitudes: <strong>${user.requestCount}</strong></div>
                    </div>
                </div>
            `).join('');
        }

        function loadLastBudgetUpdate() {
            const lastUpdate = familyData.familySettings.lastBudgetUpdate;
            document.getElementById('last-budget-update').textContent = 
                lastUpdate ? formatDate(lastUpdate) : 'Nunca';
        }

        // ========================================
        // FUNCIONES DE UTILIDAD
        // ========================================

        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'approved': 'Aprobada',
                'rejected': 'Rechazada'
            };
            return statusMap[status] || status;
        }

        function getCategoryIcon(category) {
            const icons = {
                'despensa': 'ü•ë',
                'comida': 'üçî',
                'transporte': 'üöó',
                'entretenimiento': 'üéÆ',
                'ropa': 'üëï',
                'salud': 'üè•',
                'educacion': 'üìö',
                'servicios': '‚òéÔ∏è',
                'otros': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function getCategoryName(category) {
            const names = {
                'despensa':'Despensa',
                'comida': 'Comida',
                'transporte': 'Transporte',
                'entretenimiento': 'Entretenimiento',
                'ropa': 'Ropa',
                'salud': 'Salud',
                'educacion': 'Educaci√≥n',
                'servicios':'Servicios',
                'otros': 'Otros'
            };
            return names[category] || category;
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showSuccess(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="success-message">${message}</div>`;
        }

        function clearMessages(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
        }

        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = 'Cargando...';
            } else {
                button.disabled = false;
                button.innerHTML = 'Iniciar Sesi√≥n';
            }
        }

        function getFirebaseErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'Usuario no encontrado. Verifica tu email.',
                'auth/wrong-password': 'Contrase√±a incorrecta.',
                'auth/invalid-email': 'Email inv√°lido.',
                'auth/user-disabled': 'Esta cuenta ha sido deshabilitada.',
                'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde.'
            };
            return errorMessages[errorCode] || 'Error de autenticaci√≥n. Intenta nuevamente.';
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si el usuario ya est√° autenticado (Firebase)
            
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserProfile();
                } else {
                    // Usuario no autenticado, mostrar login
                    document.getElementById('auth-container').style.display = 'block';
                    document.getElementById('main-app').style.display = 'none';
                }
            });
            
        });

        // Auto-refresh de datos cada 30 segundos (para Firebase)
        /*
        setInterval(() => {
            if (currentUser) {
                loadFamilyData();
            }
        }, 30000);
        */
    </script>
</body>
</html>
