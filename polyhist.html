<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador y Gr치ficas - Polymarket</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f9; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #111; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #d1d5db; border-radius: 6px; }
        button { padding: 12px 20px; font-size: 16px; background-color: #0052FF; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        button:hover { background-color: #003ECC; }
        .options-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .option-btn { background-color: #e0e7ff; color: #0052FF; border: 1px solid #0052FF; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: background 0.2s;}
        .option-btn:hover { background-color: #c7d2fe; }
        canvas { border: 1px solid #eee; border-radius: 8px; background-color: #fcfcfc; margin-top: 20px; width: 100%; }
        #chartContainer { display: none; }
        .loading { color: #666; font-style: italic; }
        .error { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. Buscar Mercado en Polymarket</h2>
        <p>Pega la URL completa del evento (ej. <em>https://polymarket.com/event/highest-temperature-in-nyc...</em>)</p>
        
        <div class="input-group">
            <input type="text" id="urlInput" placeholder="https://polymarket.com/event/...">
            <button onclick="searchEvent()">Buscar Opciones</button>
        </div>

        <div id="optionsContainer">
            </div>
    </div>

    <div class="card" id="chartContainer">
        <h2 id="chartTitle">Historial de Precio</h2>
        <canvas id="priceChart" height="120"></canvas>
    </div>

    <script>
        let priceChartInstance = null;
        const proxyUrl = "https://corsproxy.io/?"; // Proxy p칰blico para evitar error CORS

        // Paso 1: Buscar el evento en la API Gamma de Polymarket
        async function searchEvent() {
            const urlInput = document.getElementById('urlInput').value.trim();
            const optionsContainer = document.getElementById('optionsContainer');
            
            const match = urlInput.match(/polymarket\.com\/event\/([^/\?]+)/);
            if (!match) {
                alert("Por favor, ingresa una URL v치lida de un evento de Polymarket.");
                return;
            }
            
            const slug = match[1];
            optionsContainer.innerHTML = "<p class='loading'>Buscando evento a trav칠s del proxy...</p>";

            try {
                // URL original de la API
                const targetUrl = `https://gamma-api.polymarket.com/events?slug=${slug}`;
                // URL final pasando por el proxy y codificando la original
                const fetchUrl = proxyUrl + encodeURIComponent(targetUrl);

                const response = await fetch(fetchUrl);
                
                if (!response.ok) throw new Error("Error en la respuesta del servidor proxy o Polymarket.");
                
                const events = await response.json();

                if (!events || events.length === 0) {
                    optionsContainer.innerHTML = "<p class='error'>No se encontr칩 el evento. Verifica la URL.</p>";
                    return;
                }

                const event = events[0];
                optionsContainer.innerHTML = `<h3>Elige una opci칩n para "${event.title}":</h3><div class="options-grid" id="buttonsGrid"></div>`;
                const buttonsGrid = document.getElementById('buttonsGrid');

                event.markets.forEach(market => {
                    const optionName = market.groupItemTitle || market.question || "Opci칩n 칔nica";
                    
                    let clobIds = [];
                    try {
                        clobIds = typeof market.clobTokenIds === 'string' ? JSON.parse(market.clobTokenIds) : market.clobTokenIds;
                    } catch(e) { console.error("Error parseando IDs", e); }

                    if (clobIds && clobIds.length > 0) {
                        const yesTokenId = clobIds[0];
                        
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerText = `游늳 ${optionName}`;
                        btn.onclick = () => fetchPriceHistory(yesTokenId, optionName);
                        buttonsGrid.appendChild(btn);
                    }
                });

            } catch (error) {
                console.error("Error:", error);
                optionsContainer.innerHTML = `<p class='error'>Error de conexi칩n: ${error.message}</p>`;
            }
        }

        // Paso 2: Graficar usando la API CLOB
        async function fetchPriceHistory(tokenId, optionName) {
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('chartTitle').innerText = `Cargando historial de: ${optionName}...`;
            
            try {
                // URL original de CLOB
                const targetUrl = `https://clob.polymarket.com/prices-history?market=${tokenId}&interval=1h`;
                // URL final pasando por el proxy
                const fetchUrl = proxyUrl + encodeURIComponent(targetUrl);

                const response = await fetch(fetchUrl);
                
                if (!response.ok) throw new Error("Error obteniendo el historial.");
                
                const data = await response.json();

                if (!data.history || data.history.length === 0) {
                    document.getElementById('chartTitle').innerText = `Historial: ${optionName} (Sin datos a칰n)`;
                    alert("No hay datos hist칩ricos suficientes para esta opci칩n a칰n.");
                    return;
                }

                document.getElementById('chartTitle').innerText = `Historial: ${optionName}`;

                const labels = data.history.map(punto => new Date(punto.t * 1000).toLocaleString());
                const precios = data.history.map(punto => punto.p);

                renderChart(labels, precios, optionName);

            } catch (error) {
                console.error("Error CLOB:", error);
                document.getElementById('chartTitle').innerText = "Error al cargar la gr치fica.";
                alert("Error al cargar el historial de precios por CORS o Proxy.");
            }
        }

        function renderChart(labels, precios, optionName) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }

            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Probabilidad de "${optionName}" ($)`,
                        data: precios,
                        borderColor: '#0052FF',
                        backgroundColor: 'rgba(0, 82, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { min: 0, max: 1, title: { display: true, text: 'Precio ($)' } },
                        x: { display: false }
                    }
                }
            });
        }
    </script>
</body>
</html>
